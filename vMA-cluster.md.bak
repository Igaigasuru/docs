# How to setup vMA cluster

----

This text descrives how to create vMA (vSphere Management Assisant) cluster on EXPRESSCLUSTER for Linux.

----
## Revision histoory
2017.02.03	Miyamto Kazuyuki	1st issue

## Versions used
- VMware vSphere Hypervisor 6.0 (VMware ESXi 6.0)
- EXPRESSCLUSTER X for Linux 3.3.3-1

## Setup Procedure
- Preare two nodes of ESXi (*esxi01* and *esxi02*) with shared-storage.
- Setup a VM (to be protected by ECX) on *esxi01* and name it *VM1* for example.

#### On ESXi-1 and ESXi-2
- Deploy vMA OVF template on both ESXi and boot them.
- Configure the netowrk for ESXi and vMA to make communicatable between vMA and VMkernel port.

ESXi Example:

|			| Primary	| Secondary	|
|--			|--		|--		|
| Hostname		| esxi01	| esxi02	|
| VMkernel IP Address	| 10.0.0.1	| 10.0.0.2	|

vMA Example:

|			| Primary	| Secondary	| Note	|
|--			|--		|--		|--	|
| 3) Hostname		| vma01		| vma02		| should have independent hostname ( "localhost" is inappropriate ) |
| 4) DNS		|		|		||
| 5) Proxy Server	|		|		||
| 6) IP Address		| 10.0.0.11	| 10.0.0.12	| should have independent static IP Address |

  the IP address should be possible to communicate with VMkernel of both ESXi.

#### On vMA-1 and vMA-2 
- Put ECX rpm file and its license file by using scp command and so on.
- Install ECX

		> sudo bash
		# rpm -ivh expresscls-3.3.3-1.x86_64.rpm
		# clplcnsc -I [license file] -P BASE33
		# reboot

- Configure ECX
  - Access http://[IP_Address_of_Primary_node]:29003/ with web browser to open *Cluster Manager*
  - Change to [Config Mode] from [Operation Mode]
  - [File] > [Cluster Generation Wizard]
  - [Start Cluster Generation Wizard for standard edition]
  - Input *vMA-cluster* as Cluster Name, [English] as Language > [Next]
  - [Add] > input [IP Address of secondary server] > [OK] > [Next]
  - [Next]
  - [Next]
  - [Add]
  - input *failover-VMn* as [Name] > [Next]
  - [Next]
  - [Next]
  - [Add]
  - Select [execute resource] as [Type] > input *exec-VMn* as [Name] > [Next]
  - [Next]
  - Select [Stop the cluster service and regoot OS] as [Final Action] in [Recovery Operation at Deactivation Failure Detection] > [Next]
  - Select [start.sh] > [Replace] > Select *vm-start.pl* >  
    Select [stop.sh]  > [Replace] > Select *vm-stop.pl* >  
    [Tuning] > [Maintenance] tab > Input */opt/nec/clusterpro/log/exec-VMn.log* as [Log Outpu Path] > Check [Rotate Log] > [OK] > [Finish]
  - [Finish]
  - [Next]
  - [Add] > select [custom monitor] as [Type] > input *genw-VMn* as [Name] > [Next]
  - select [Active] as [Monitoring Timig] > [Browse] >  
    select [exec-VMn] > [OK] > [Next]
  - [Replace] > select *vm-monitor.pl* >  
    input */opt/nec/clusterpro/log/genw-VMn.log* as [Log Output Path] >  
    Check [Rotate Log] > [Next]
  - select [Executing failover to the recovery target] > [Browse] >  
    select [failvoer-VMn] > [OK] >  
    [Finish]
  - [Finish] > [Yes]
  - [File] menu > [Apply the Configuration File]
  
  - on both node (vma01, vma02)
    - setup root user credential for both ESXi by using /usr/lib/vmware-vcli/apps/general/credstore_admin.pl

    		# /usr/lib/vmware-vcli/apps/general/credstore_admin.pl add -s {IP_of_esxi01} -u root -p {password}

  - on vma01
    - Get the path information for the VMn with the command
    
    		# vmware-cmd --server 10.0.0.1 -U root -l 
    		
    		/vmfs/volumes/588b1739-87411a6f-618f-002421a9b4be/cent7/cent7.vmx

    - copy *vmconf.pl* to /opt/nec/clusterpro/scripts/failover-VMn/exec-VMn/vmconf.pl
    - edit *vmconf.pl*

###
### to be edited
###
  
#### On Cluster Manager
  - Change to [Operation Mode] > [Service] menu > [Start Cluster]


## Tips

#### Registering ESXi root credential on vMA HOWTO 

Assuming belows.

- IP address for "VMkernel port" of ESXi host
	- 10.0.0.1	(for ESXi-1)
	- 10.0.0.2	(for ESXi-2)

- IP address for "vSphere Management Assistant" on ESXi
	- 10.0.0.11	(for vMA-1 on ESX-1)
	- 10.0.0.12	(for vMA-2 on ESX-2)

- root password to access "VMkernel port" is
	- passwd1	(for 10.0.0.1)
	- passwd2	(for 10.0.0.2)

On vMA-1 console, register root password to allow access from EC scrips as below.

		# /usr/lib/vmware-vcli/apps/general/credstore_admin.pl add -s 10.0.0.1 -u root -p passwd1
		New entry added successfully
		# /usr/lib/vmware-vcli/apps/general/credstore_admin.pl add -s 10.0.0.2 -u root -p passwd2
		New entry added successfully
		# /usr/lib/vmware-vcli/apps/general/credstore_admin.pl list
		Server	user Name
		10.0.0.1	root
		10.0.0.2	root
		
		Server 	Uhumbprint
		#

<!--
# vMA の OVF を他の環境でデプロイして使う場合に変更が必要となる部分

	- 保護対象の VM を共有ディスク (iSCSI Target) に移動させる。
		- vSphere Client から Datastore Browser を使って .vmx の入っているフォルダを まるごと共有ディスクへコピーする
		- 「

	- /opt/nec/clusterpro/scripts/{Group Name}/{Resource Name}/vmconf.pl
		- 保護対象 VM の vmkernel 内での格納 path

			vMA にログインして以下のコマンドで出力される .vmx ファイルのパスを指定する。
			
				# vmware-cmd -H {ESXi#1_IP} -U root -P {password} -l
	 	
	 	- ESXi 1号機、2号機の VMkernel port の IP address
	 	- vMA 1号機、2号機の IP address

	- /usr/lib/vmware-vcli/apps/general/credstore_admin.pl
	 を使って ESXi 1, 2号機の root パスワード を vMA に登録する。
	
	 	/usr/lib/vmware-vcli/apps/general/credstore_admin.pl add -s {ESXi#1_IP} -u root -p {password}

## Notes

管理対象VM が vSphere Clinet 上、左ペインのツリーに、

	/vmfs/volumes/[LUNID]/[vm name]/[vm name].vmx (inaccessible)

と 薄いグレー で表示されている場合は、それらを **手動で** 削除する

	対象VMを右クリック > [Remove from Inventory]


-->
